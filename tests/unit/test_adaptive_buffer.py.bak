"""Unit test for AdaptiveRingBuffer tier transitions."""

import pytest
import numpy as np
from server.ring_buffer import RingBuffer


def test_adaptive_ring_buffer_initialization():
    """Test that buffer initializes in normal tier."""
    buffer = RingBuffer(capacity_samples=88200, sample_rate=44100, chunk_size=4410)

    assert buffer.capacity_samples == 88200
    assert buffer.chunk_size == 4410
    assert buffer.sample_rate == 44100
    print("✅ Buffer initializes correctly in normal tier")


def test_buffer_capacity_chunks():
    """Test that get_capacity returns correct chunk count."""
    buffer = RingBuffer(capacity_samples=88200, sample_rate=44100, chunk_size=4410)
    capacity_chunks = buffer.get_capacity()

    expected_capacity = 88200 // 4410  # 20 chunks
    assert capacity_chunks == expected_capacity
    assert capacity_chunks == 20
    print(f"✅ Buffer capacity: {capacity_chunks} chunks")


def test_buffer_depth_calculation():
    """Test that get_buffer_depth_ms returns correct values."""
    buffer = RingBuffer(capacity_samples=88200, sample_rate=44100, chunk_size=4410)

    # Empty buffer
    assert buffer.get_buffer_depth_ms() == 0.0

    # Half full (10 chunks = 1 second)
    for i in range(10):
        audio = __import__("numpy", "np").zeros((2, 4410), dtype=np.float32)
        buffer.write(audio)

    assert 900 <= buffer.get_buffer_depth_ms() <= 1100  # 1.0-1.1 seconds
    print(f"✅ Buffer depth at half full: {buffer.get_buffer_depth_ms():.0f}ms")


def test_buffer_clear():
    """Test that clear resets buffer and cursors."""
    buffer = RingBuffer(capacity_samples=88200, sample_rate=44100, chunk_size=4410)

    # Add some data
    audio = __import__("numpy", "np").zeros((2, 4410), dtype=np.float32)
    buffer.write(audio)

    # Verify not empty
    assert buffer.get_buffer_depth_ms() > 0

    # Clear
    buffer.clear()

    # Verify empty
    assert buffer.get_buffer_depth_ms() == 0.0
    assert buffer.read() is None  # No data available
    print("✅ Buffer clear resets correctly")


def test_chunk_write_and_read():
    """Test chunk write and read operations."""
    buffer = RingBuffer(capacity_samples=88200, sample_rate=44100, chunk_size=4410)

    # Write chunk
    chunk = __import__("numpy", "np").random.randn(2, 4410).astype(np.float32)
    chunk_id = buffer.write_chunk(chunk)

    # Read chunk back
    read_chunk = buffer.read()

    assert read_chunk is not None
    assert read_chunk.shape == (8820,)  # 1D interleaved
    print(f"✅ Chunk write/read successful, chunk ID: {chunk_id}")
