<!DOCTYPE html>
<html>
<head>
    <title>Auralis Debug</title>
</head>
<body>
    <h1>Auralis Audio Debug</h1>
    <button id="testBtn">Test Audio Connection</button>
    <pre id="log"></pre>

    <script>
        const log = document.getElementById('log');
        function addLog(msg) {
            log.textContent += new Date().toISOString() + ': ' + msg + '\n';
            console.log(msg);
        }

        document.getElementById('testBtn').addEventListener('click', async () => {
            try {
                addLog('Creating AudioContext...');
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog(`AudioContext created: ${audioContext.sampleRate}Hz, state: ${audioContext.state}`);

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    addLog('AudioContext resumed');
                }

                addLog('Loading AudioWorklet module...');
                await audioContext.audioWorklet.addModule('audio_worklet_processor.js');
                addLog('AudioWorklet module loaded');

                addLog('Creating AudioWorkletNode...');
                const workletNode = new AudioWorkletNode(audioContext, 'auralis-audio-processor');
                addLog('AudioWorkletNode created');

                workletNode.port.onmessage = (e) => {
                    addLog(`Worklet message: ${JSON.stringify(e.data)}`);
                };

                workletNode.connect(audioContext.destination);
                addLog('AudioWorkletNode connected to destination');

                addLog('Connecting to WebSocket...');
                const ws = new WebSocket('ws://localhost:8000/ws/stream');

                ws.onopen = () => {
                    addLog('WebSocket connected');
                };

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'audio') {
                        addLog(`Received audio chunk: sequence ${msg.sequence}, ${msg.data.length} bytes`);

                        // Decode and send to worklet
                        const binaryString = atob(msg.data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const int16Array = new Int16Array(bytes.buffer);
                        const float32Array = new Float32Array(int16Array.length);
                        for (let i = 0; i < int16Array.length; i++) {
                            float32Array[i] = int16Array[i] / 32767.0;
                        }

                        workletNode.port.postMessage({ type: 'audio', samples: float32Array });
                        addLog(`Sent ${float32Array.length} samples to worklet`);
                    } else {
                        addLog(`WebSocket message: ${JSON.stringify(msg)}`);
                    }
                };

                ws.onerror = (error) => {
                    addLog(`WebSocket error: ${error}`);
                };

                ws.onclose = () => {
                    addLog('WebSocket closed');
                };

            } catch (error) {
                addLog(`ERROR: ${error.message}`);
                console.error(error);
            }
        });
    </script>
</body>
</html>
